/*!
 * PhpSPA Client Runtime v2.0.8
 * Docs: https://phpspa.tech | Package: @dconco/phpspa
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).phpspa={})}(this,function(e){"use strict";function t(e){try{return btoa(e)}catch(t){try{const t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}catch(t){return btoa(e.split("").map(function(e){return String.fromCharCode(255&e.charCodeAt(0))}).join(""))}}}class n{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static currentStateData;static lastEventPayload={};static effects=new Set;static memoizedCallbacks=[];static registerEffect(e,t=null){const r=e(),a={callback:e,dependencies:t,cleanup:"function"==typeof r?r:null,lastDeps:t?n.resolveDependencies(t):null};n.effects.add(a)}static triggerEffects(e,t){n.effects.forEach(e=>{if(!e.dependencies||0===e.dependencies.length)return void n.invokeEffect(e,e.dependencies);const t=n.resolveDependencies(e.dependencies);e.lastDeps&&n.depsEqual(e.lastDeps,t)||n.invokeEffect(e,t)})}static clearEffects(){n.effects.forEach(e=>{e.cleanup&&e.cleanup()}),n.effects.clear()}static depsEqual(e,t){return e===t||!(!e||!t)&&(e.length===t.length&&e.every((e,n)=>Object.is(e,t[n])))}static registerCallback(e,t=[]){const r=n.resolveDependencies(t),a=n.memoizedCallbacks.find(e=>e.deps.length===t.length&&n.depsEqual(e.resolvedDeps,r));if(a)return a.callback;const o=e.bind(void 0);return n.memoizedCallbacks.push({deps:t.slice(),resolvedDeps:r,callback:o}),o}static resolveDependencies(e){return e.map(e=>n.resolveDependency(e))}static resolveDependency(e){return"string"==typeof e&&n.currentStateData&&Object.prototype.hasOwnProperty.call(n.currentStateData,e)?n.currentStateData[e]:e}static invokeEffect(e,t){if(e.cleanup)try{e.cleanup()}catch(e){console.error("Error in effect cleanup:",e)}try{const t=e.callback();e.cleanup="function"==typeof t?t:null}catch(t){console.error("Error in effect callback:",t),e.cleanup=null}e.lastDeps=t?t.slice():t}static runAll(){for(const e in n.currentRoutes){const t=document.getElementById(e);t&&(this.runInlineScripts(t),this.runPhpSpaScripts(t),this.runInlineStyles(t))}}static runInlineScripts(e){const n=e.querySelectorAll("script"),r=document.head.getAttribute("x-phpspa");n.forEach(e=>{const n=t(e.textContent.trim());if(!this.executedScripts.has(n)&&""!==e.textContent.trim()){this.executedScripts.add(n);const t=document.createElement("script");t.nonce=r??void 0;for(const n of Array.from(e.attributes))t.setAttribute(n.name,n.value);const a=e.hasAttribute("async");t.textContent=a?`(async function() {\n${e.textContent}\n})()`:`(function() {\n${e.textContent}\n})()`,document.head.appendChild(t).remove()}})}static runPhpSpaScripts(e){const t=e.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]'),n=document.head.getAttribute("x-phpspa");t.forEach(async e=>{const t=e.getAttribute("src")??"",r=e.getAttribute("type")??"";if(!this.executedScripts.has(t)){if(this.executedScripts.add(t),this.ScriptsCachedContent[t]){const e=document.createElement("script");return e.textContent=this.ScriptsCachedContent[t],e.nonce=n??void 0,e.type=r,void document.head.appendChild(e).remove()}const e=await fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(e.ok){const a=await e.text(),o=document.createElement("script");o.textContent=a,o.nonce=n??void 0,o.type=r,document.head.appendChild(o).remove(),this.ScriptsCachedContent[t]=a}else console.error(`Failed to load script from ${t}: ${e.statusText}`)}})}static clearExecutedScripts(){n.executedScripts.clear()}static runInlineStyles(e){const n=e.querySelectorAll("style"),r=document.head.getAttribute("x-phpspa");n.forEach(e=>{const n=t(e.textContent.trim());if(!this.executedStyles.has(n)&&""!==e.textContent.trim()){this.executedStyles.add(n);const t=document.createElement("style");t.nonce=r??void 0;for(const n of Array.from(e.attributes))t.setAttribute(n.name,n.value);t.textContent=e.textContent,document.head.appendChild(t).remove()}})}static emit(e,t){const n=this.events[e]||[];this.lastEventPayload[e]=t;for(const r of n)if("function"==typeof r)try{r(t)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static getLastEventPayload(e){return this.lastEventPayload[e]}static pushState(e,t,n){try{history.pushState(e,t,n)}catch(e){console.warn("Failed to push history state:",e instanceof Error?e.message:e)}}static replaceState(e,t,n){try{history.replaceState(e,t,n)}catch(e){console.warn("Failed to replace history state:",e instanceof Error?e.message:e)}}}var r;var a="undefined"==typeof document?void 0:document,o=!!a&&"content"in a.createElement("template"),i=!!a&&a.createRange&&"createContextualFragment"in a.createRange();function c(e){return e=e.trim(),o?function(e){var t=a.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):i?function(e){return r||(r=a.createRange()).selectNode(a.body),r.createContextualFragment(e).childNodes[0]}(e):function(e){var t=a.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function s(e,t){var n,r,a=e.nodeName,o=t.nodeName;return a===o||(n=a.charCodeAt(0),r=o.charCodeAt(0),n<=90&&r>=97?a===o.toUpperCase():r<=90&&n>=97&&o===a.toUpperCase())}function l(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var d={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}l(e,t,"selected")},INPUT:function(e,t){l(e,t,"checked"),l(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var a=r.nodeValue;if(a==n||!n&&a==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,a=-1,o=0,i=e.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){a=o;break}o++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}e.selectedIndex=a}}};function u(){}function f(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var p=function(e){return function(t,n,r){if(r||(r={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var o=n;(n=a.createElement("html")).innerHTML=o}else n=c(n);else 11===n.nodeType&&(n=n.firstElementChild);var i=r.getNodeKey||f,l=r.onBeforeNodeAdded||u,p=r.onNodeAdded||u,h=r.onBeforeElUpdated||u,m=r.onElUpdated||u,g=r.onBeforeNodeDiscarded||u,y=r.onNodeDiscarded||u,v=r.onBeforeElChildrenUpdated||u,S=r.skipFromChildren||u,b=r.addChild||function(e,t){return e.appendChild(t)},E=!0===r.childrenOnly,C=Object.create(null),x=[];function T(e){x.push(e)}function w(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=i(n))?T(r):(y(n),n.firstChild&&w(n,t)),n=n.nextSibling}}function A(e,t,n){!1!==g(e)&&(t&&t.removeChild(e),y(e),w(e,n))}function D(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=i(t);n&&(C[n]=t),D(t),t=t.nextSibling}}function N(e){p(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=i(t);if(r){var a=C[r];a&&s(t,a)?(t.parentNode.replaceChild(a,t),I(a,t)):N(t)}else N(t);t=n}}function I(t,n,r){var o=i(n);if(o&&delete C[o],!r){var c=h(t,n);if(!1===c)return;if(c instanceof HTMLElement&&D(t=c),e(t,n),m(t),!1===v(t,n))return}"TEXTAREA"!==t.nodeName?function(e,t){var n,r,o,c,u,f=S(e,t),p=t.firstChild,h=e.firstChild;e:for(;p;){for(c=p.nextSibling,n=i(p);!f&&h;){if(o=h.nextSibling,p.isSameNode&&p.isSameNode(h)){p=c,h=o;continue e}r=i(h);var m=h.nodeType,g=void 0;if(m===p.nodeType&&(1===m?(n?n!==r&&((u=C[n])?o===u?g=!1:(e.insertBefore(u,h),r?T(r):A(h,e,!0),r=i(h=u)):g=!1):r&&(g=!1),(g=!1!==g&&s(h,p))&&I(h,p)):3!==m&&8!=m||(g=!0,h.nodeValue!==p.nodeValue&&(h.nodeValue=p.nodeValue))),g){p=c,h=o;continue e}r?T(r):A(h,e,!0),h=o}if(n&&(u=C[n])&&s(u,p))f||b(e,u),I(u,p);else{var y=l(p);!1!==y&&(y&&(p=y),p.actualize&&(p=p.actualize(e.ownerDocument||a)),b(e,p),N(p))}p=c,h=o}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=i(t))?T(n):A(t,e,!0),t=r}}(e,h,r);var v=d[e.nodeName];v&&v(e,t)}(t,n):d.TEXTAREA(t,n)}D(t);var O,k,R=t,P=R.nodeType,L=n.nodeType;if(!E)if(1===P)1===L?s(t,n)||(y(t),R=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(t,(O=n.nodeName,(k=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==k?a.createElementNS(k,O):a.createElement(O)))):R=n;else if(3===P||8===P){if(L===P)return R.nodeValue!==n.nodeValue&&(R.nodeValue=n.nodeValue),R;R=n}if(R===n)y(t);else{if(n.isSameNode&&n.isSameNode(R))return;if(I(R,n,E),x)for(var U=0,_=x.length;U<_;U++){var B=C[x[U]];B&&A(B,B.parentNode,!1)}}return!E&&R!==t&&t.parentNode&&(R.actualize&&(R=R.actualize(t.ownerDocument||a)),t.parentNode.replaceChild(R,t)),R}}(function(e,t){var n,r,a,o,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,a=n.namespaceURI,o=n.value,a?(r=n.localName||r,e.getAttributeNS(a,r)!==o&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(a,r,o))):e.getAttribute(r)!==o&&e.setAttribute(r,o);for(var s=e.attributes,l=s.length-1;l>=0;l--)r=(n=s[l]).name,(a=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(a,r)||e.removeAttributeNS(a,r)):t.hasAttribute(r)||e.removeAttribute(r)}});class h{static currentStateData={};static navigate(e,t="push"){const r=e instanceof URL?e:new URL(e,location.toString());function a(e){e.response?e.response.text().then(t=>{let a;try{a=t?.trim().startsWith("{")?JSON.parse(t):t}catch(e){a=t}o(a||""),n.emit("load",{route:r.toString(),success:!1,error:e.message||"Server returned an error",data:a})}).catch(()=>{o(""),n.emit("load",{route:r.toString(),success:!1,error:e.message||"Failed to read error response"})}):(o(""),n.emit("load",{route:r.toString(),success:!1,error:e.message||"No connection to server"}))}function o(e){const a="string"==typeof e?{content:e,stateData:{}}:e;n.currentStateData=a.stateData,a?.title&&a.title.length>0&&(document.title=a.title);const o=document.getElementById(a?.targetID)??document.getElementById(history.state?.targetID)??document.body;a?.targetID&&(n.currentRoutes[a.targetID]={route:r,exact:a.exact??!1,defaultContent:n.currentRoutes[a.targetID]?.defaultContent??o.innerHTML});const i=n.currentRoutes;for(const e in i){if(!Object.hasOwn(i,e))continue;const t=i[e];if(!0===t.exact&&e!==a?.targetID){let n=document.getElementById(e);if(n)try{p(n,"<div>"+t.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t.defaultContent}delete i[e]}}const c=()=>{try{p(o,"<div>"+a.content+"</div>",{childrenOnly:!0})}catch{o.innerHTML=a.content}},s={url:r.toString(),title:a?.title??document.title,targetID:o.id,content:a.content,exact:i[a?.targetID]?.exact,defaultContent:i[a?.targetID]?.defaultContent};a?.reloadTime&&(s.reloadTime=a.reloadTime);const l=()=>{"push"===t?n.pushState(s,s.title,r):"replace"===t&&n.replaceState(s,s.title,r);const e=document.getElementById(r.hash.substring(1));e?scroll({top:e.offsetTop,left:e.offsetLeft}):scroll(0,0),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),n.emit("load",{route:r.toString(),success:!0,error:!1}),a?.reloadTime&&setTimeout(h.reloadComponent,a.reloadTime)};document.startViewTransition?document.startViewTransition(c).finished.then(l).catch(e=>{n.emit("load",{route:r.toString(),success:!1,error:e||"Unknown error during view transition"})}):(c(),l())}n.emit("beforeload",{route:r.toString()}),fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";o(t)}).catch(e=>a(e))}).catch(e=>a(e))}static back(){history.back()}static forward(){history.forward()}static reload(){h.navigate(location.toString(),"replace")}static on(e,t){n.events[e]||(n.events[e]=[]),n.events[e].push(t);const r=n.getLastEventPayload(e);if(r)try{t(r)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static useEffect(e,t=null){n.registerEffect(e,t)}static useCallback(e,t=[]){return n.registerCallback(e,t)}static setState(e,r){return"function"==typeof r&&(r=r(n.currentStateData[e])),new Promise(async(a,o)=>{const i=n.currentRoutes,c=JSON.stringify({state:{key:e,value:r}}),s=[];for(const e in i){if(!Object.hasOwn(i,e))continue;const{route:n}=i[e],r=fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${t(c)}`},mode:"same-origin",redirect:"follow",keepalive:!0});s.push(r)}function l(t){const a="string"==typeof t?{content:t,stateData:{}}:t;n.currentStateData=a.stateData,a?.title&&String(a.title).length>0&&(document.title=a.title);const o=document.getElementById(a?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{p(o,"<div>"+a.content+"</div>",{childrenOnly:!0})}catch{o.innerHTML=a.content}})(),n.triggerEffects(e,r)}(await Promise.all(s)).forEach(async e=>{try{const t=await e.text();let n;if(t&&t.trim().startsWith("{"))try{n=JSON.parse(t)}catch(e){n=t}else n=t||"";a(),l(n)}catch(e){o(e),function(e){e?.response?e.response.text().then(e=>{let t;try{t=e?.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}l(t||"")}).catch(()=>{l("")}):l("")}(e)}})})}static reloadComponent(){function e(e){e?.response?e.response.text().then(e=>{let n;try{n=e?.trim().startsWith("{")?JSON.parse(e):e}catch(t){n=e}t(n||"")}).catch(()=>{t("")}):t("")}function t(e){const t="string"==typeof e?{content:e,stateData:{}}:e;n.currentStateData=t.stateData,t?.title&&String(t.title).length>0&&(document.title=t.title);const r=document.getElementById(t?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{p(r,"<div>"+t.content+"</div>",{childrenOnly:!0})}catch{r.innerHTML=t.content}})(),n.clearEffects(),n.clearExecutedScripts(),n.runAll(),t?.reloadTime&&setTimeout(h.reloadComponent,t.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(n=>{n.text().then(e=>{let n;if(e&&e.trim().startsWith("{"))try{n=JSON.parse(e)}catch(t){n=e}else n=e||"";t(n)}).catch(t=>{e(t)})}).catch(t=>{e(t)})}static async __call(e,...n){const r=JSON.stringify({__call:{token:e,args:n}});try{const e=await fetch(location.pathname,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${t(r)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await e.text();let a;if(n&&n.trim().startsWith("{"))try{a=JSON.parse(n),a=a?.response?JSON.parse(a.response):a}catch(e){a=n}else a=n||"";return a}catch(e){if(!e?.response)return"";try{const t=await e.response.text();let n;try{n=t?.trim().startsWith("{")?JSON.parse(t):t,n=n?.response?JSON.parse(n.response):n}catch(e){n=t}return n}catch{return""}}}}function m(){const e=document.querySelector("[data-phpspa-target]"),t=document.querySelector("[phpspa-target-data]"),r=location.toString();if(n.emit("load",{route:r,success:!0,error:!1}),e){const a={url:r,title:document.title,targetID:e.id,content:e.innerHTML,root:!0};if(t){const o=t.getAttribute("phpspa-target-data"),i=JSON.parse(function(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return(new TextDecoder).decode(n)}catch(t){return atob(e)}}(o??""));i.reloadTime&&(a.reloadTime=i.reloadTime),n.currentStateData=i.stateData,i.targetIDs.forEach((t,o)=>{const c=i.exact[o],s=i.defaultContent[o];t===e.id&&(a.exact=c,a.defaultContent=s),n.currentRoutes[t]={route:new URL(i.currentRoutes[o],r),defaultContent:s,exact:c}})}n.replaceState(a,document.title,r),a.reloadTime&&setTimeout(h.reloadComponent,a.reloadTime)}document.addEventListener("click",e=>{if(e.defaultPrevented||0!==e.button)return;if(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)return;const t=e.target?.closest?.('a[data-type="phpspa-link-tag"]');if(!t)return;if(t.hasAttribute("download"))return;if(t.getAttribute("target")&&"_self"!==t.getAttribute("target"))return;const n=t.getAttribute("href");if(!n)return;const r=new URL(n,location.toString());r.origin===location.origin&&(e.preventDefault(),h.navigate(r,"push"))})}class g extends h{}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",m,{once:!0}):["interactive","complete"].includes(document.readyState)&&m(),window.addEventListener("popstate",e=>{const t=e.state;if(n.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",t&&t.content){document.title=t.title??document.title;const e=document.getElementById(t.targetID);if(!e)return void location.reload();t.targetID&&(n.currentRoutes[t.targetID]={route:new URL(t.url),exact:t.exact??!1,defaultContent:t.defaultContent||""});const r=n.currentRoutes;for(const e in r){if(!Object.hasOwn(r,e))continue;const n=r[e];if(!0===n.exact&&e!==t.targetID){let t=document.getElementById(e);if(t)try{p(t,"<div>"+n.defaultContent+"</div>",{childrenOnly:!0})}catch{t.innerHTML=n.defaultContent}delete r[e]}}const a=()=>{try{p(e,"<div>"+t.content+"</div>",{childrenOnly:!0})}catch{e.innerHTML=t.content}},o=()=>{n.clearEffects(),n.clearExecutedScripts(),n.runAll(),t?.reloadTime&&setTimeout(h.reloadComponent,t.reloadTime),n.emit("load",{route:t.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(a).finished.then(o).catch(e=>{n.emit("load",{route:location.href,success:!1,error:e||"Unknown error during view transition"})}):(a(),o())}else location.reload()}),"undefined"!=typeof window&&(window.phpspa=g,window.setState!==g.setState&&(window.setState=g.setState),window.__call!==g.__call&&(window.__call=g.__call),window.useEffect!==g.useEffect&&(window.useEffect=g.useEffect),window.useCallback!==g.useCallback&&(window.useCallback=g.useCallback));const y=g.setState.bind(g),v=g.useEffect.bind(g),S=g.useCallback.bind(g),b=g.__call.bind(g);e.__call=b,e.default=g,e.setState=y,e.useCallback=S,e.useEffect=v,Object.defineProperty(e,"__esModule",{value:!0})});
