# --- PORTABLE NGINX CONFIG (Copy this to /etc/nginx/sites-available/ on production) ---
map $scheme $hsts_header {
   https "max-age=31536000; includeSubDomains";
}

server {
   listen 80;
   server_name localhost; # Change to your domain or 'localhost'
   root /mnt/c/Users/HP/Desktop/spyrochat/php/public; # Path to your project folder
   index index.php index.html;

   # 1. THE STRATEGY: Only serve existing files, everything else to index.php
   location / {
      try_files $uri /index.php?$query_string;
   }

   # 2. MIME TYPE: Manifest
   location ~* \.webmanifest$ {
      types { }
      default_type application/manifest+json;
   }

   # Handle PHP files (Connects to PHP-FPM)
   location ~ \.php$ {
      include snippets/fastcgi-php.conf;
      fastcgi_pass unix:/var/run/php/php8.5-fpm.sock; # Check your PHP version!

      # This replaces the "Authorization Header" rewrite rule in .htaccess
      fastcgi_param HTTP_AUTHORIZATION $http_authorization;
   }

   # 3. SECURITY HEADERS: (1:1 Port of your .htaccess)
   add_header X-Content-Type-Options "nosniff" always;
   add_header X-Frame-Options "DENY" always;
   add_header X-XSS-Protection "1; mode=block" always;
   add_header Referrer-Policy "strict-origin-when-cross-origin" always;

   # HSTS (Equivalent to your env=HTTPS logic)
   add_header Strict-Transport-Security $hsts_header always;

   # 4. PERFORMANCE: Gzip (Equivalent to mod_deflate)
   gzip on;
   gzip_vary on;
   gzip_proxied any;
   gzip_comp_level 6;
   gzip_types text/plain text/css application/javascript application/json image/svg+xml font/ttf font/otf font/opentype;

   # --- 4. WEBSOCKET BRIDGE (For Go) ---
   location /ws {
      proxy_pass http://172.30.48.1:8000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;

      # Fixes the "No Access-Control-Allow-Origin" error in your screenshot
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
   }
}
